"use strict";var _path=_interopRequireDefault(require("path")),_loaderUtils=_interopRequireDefault(require("loader-utils")),_compilationConfig=require("@hap-toolkit/shared-utils/compilation-config"),_compiler=require("@hap-toolkit/compiler"),_validator=_interopRequireDefault(require("@hap-toolkit/compiler/lib/template/validator")),_info=require("../common/info.js"),_uxFragmentUtils=require("./ux-fragment-utils"),_utils=require("../common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const pkgInfo=require("../../package.json");function parseImportList(e,t){return Promise.all(t.map(t=>resolveImportItemSrc(e,t)))}function resolveImportItemSrc(e,t){return t.attrs.src?new Promise(r=>{e.resolve(e.context,t.attrs.src,function(e,p){return e?(t.isValid=!1,t.err=e,r(t)):(t.isValid=!0,t.srcPath=p,r(t))})}):(t.isValid=!1,Promise.resolve(t))}function assemble(e,t,r,p){let a="";if(p===_utils.ENTRY_TYPE.APP)a+=(0,_uxFragmentUtils.processScriptFrag)(e,t.script,p),a+=`\n$app_define$('@app-application/${r}', [], function($app_require$, $app_exports$, $app_module$){\n`,t.script.length>0&&(a+="     $app_script$($app_module$, $app_exports$, $app_require$)\n",a+="     if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default;\n        }\n",a+="     $app_module$.exports['manifest'] = manifestJson;\n"),a+="})\n",a+=`\n$app_bootstrap$('@app-application/${r}',{ packagerVersion: '${pkgInfo.version}'})\n`;else{const o=[];a+=(0,_uxFragmentUtils.processImportFrag)(e,t.import,o),a+=(0,_uxFragmentUtils.processTemplateFrag)(e,t.template,p,o),a+=(0,_uxFragmentUtils.processStyleFrag)(e,t.style,p),a+=(0,_uxFragmentUtils.processScriptFrag)(e,t.script,p),a+=`\n$app_define$('@app-component/${r}', [], function($app_require$, $app_exports$, $app_module$){\n`,t.script.length>0&&(a+="     $app_script$($app_module$, $app_exports$, $app_require$)\n",a+="     if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default\n        }\n"),a+="     $app_module$.exports.template = $app_template$\n",t.style.length>0&&(a+="     $app_module$.exports.style = $app_style$\n"),a+="})\n",(0,_utils.isUXRender)(p)&&(a+=`\n$app_bootstrap$('@app-component/${r}',{ packagerVersion: '${pkgInfo.version}'})\n`),p===_utils.ENTRY_TYPE.COMP&&_compilationConfig.options.enableLazyComponent&&(a=`\n$app_define_wrap$('@app-component/${r}', function () {\n ${a} \n})\n`)}return a}function loader(e){const t=this.async();this.cacheable&&this.cacheable();const r=this.resourcePath,{ext:p}=_path.default.parse(r);if(-1===_info.name.extList.indexOf(p))return void t(new Error(`未知文件格式：${p}`));const a=_loaderUtils.default.parseQuery(this.resourceQuery),o=a.uxType,i=a.name||(0,_utils.getNameByPath)(r);_validator.default.isReservedTag(i)&&(0,_utils.logWarn)(this,[{reason:"脚本文件名不能使用保留字:"+i}]),(0,_utils.print)({resourceQuery:this.resourceQuery,resourcePath:r,name:i});const s=(0,_compiler.parseFragmentsWithCache)(e,r);(0,_utils.print)(s),parseImportList(this,s.import).then(()=>assemble(this,s,i,o,r)).then(e=>{t(null,e)}).catch(e=>{t(e,"")})}module.exports=loader;
//# sourceMappingURL=ux-loader.js.map
